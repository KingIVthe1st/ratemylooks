<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Infinite Loop Fix Test - RateMyLooks.ai</title>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 100%);
            color: white;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .test-title {
            text-align: center;
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 30px;
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .upload-area {
            border: 2px dashed rgba(59, 130, 246, 0.5);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(59, 130, 246, 0.05);
            margin: 20px 0;
        }
        
        .upload-area:hover {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
            transform: translateY(-2px);
        }
        
        .upload-area.drag-over {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }
        
        .upload-icon {
            font-size: 3rem;
            margin-bottom: 20px;
        }
        
        .upload-text {
            font-size: 1.1rem;
            margin-bottom: 10px;
        }
        
        .upload-link {
            color: #3b82f6;
            font-weight: 600;
        }
        
        .upload-info {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
        }
        
        .upload-preview {
            text-align: center;
            margin: 20px 0;
        }
        
        .upload-preview img {
            max-width: 300px;
            max-height: 300px;
            border-radius: 15px;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }
        
        .preview-overlay {
            margin-top: 15px;
        }
        
        .preview-remove {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .preview-remove:hover {
            background: #dc2626;
            transform: scale(1.1);
        }
        
        .upload-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: not-allowed;
            transition: all 0.3s ease;
            margin: 20px 0;
        }
        
        .upload-btn.enabled {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%) !important;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.4);
            transform: translateY(-2px);
        }
        
        .upload-btn:disabled {
            opacity: 0.7;
        }
        
        .test-log {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 300px;
            overflow-y: auto;
            border-left: 4px solid #3b82f6;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding: 5px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .log-success {
            color: #10b981;
        }
        
        .log-error {
            color: #ef4444;
        }
        
        .log-warning {
            color: #f59e0b;
        }
        
        .log-info {
            color: #3b82f6;
        }
        
        .test-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 10px;
        }
        
        .stat-label {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
        }
        
        .btn-test {
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            margin: 10px;
            transition: all 0.3s ease;
        }
        
        .btn-test:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(139, 92, 246, 0.3);
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1 class="test-title">üêõ Infinite Loop Fix Test</h1>
        
        <div class="test-stats">
            <div class="stat-card">
                <div class="stat-number" id="clickCount">0</div>
                <div class="stat-label">Upload Area Clicks</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="triggerCount">0</div>
                <div class="stat-label">File Input Triggers</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="errorCount">0</div>
                <div class="stat-label">Errors Detected</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="blockCount">0</div>
                <div class="stat-label">Blocked Interactions</div>
            </div>
        </div>
        
        <!-- Test Upload Area -->
        <div class="upload-area" id="uploadArea">
            <div class="upload-content">
                <div class="upload-icon">üì∑</div>
                <div class="upload-text">
                    <p class="upload-main">Click here to test upload (Fixed Version)</p>
                    <p class="upload-info">This should NOT cause infinite loops</p>
                </div>
            </div>
            <input type="file" id="fileInput" accept="image/*" hidden>
        </div>
        
        <div class="upload-preview" id="uploadPreview" style="display: none;">
            <img id="previewImage" alt="Preview">
            <div class="preview-overlay">
                <button class="preview-remove" id="removeImage">√ó</button>
            </div>
        </div>
        
        <button class="upload-btn" id="uploadBtn" disabled>
            <span class="btn-text">Get My Rating üî•</span>
        </button>
        
        <div>
            <button class="btn-test" onclick="runStressTest()">üß™ Stress Test (100 rapid clicks)</button>
            <button class="btn-test" onclick="simulateEdgeCase()">‚ö†Ô∏è Test Edge Cases</button>
            <button class="btn-test" onclick="clearLogs()">üóëÔ∏è Clear Logs</button>
            <button class="btn-test" onclick="resetStats()">üîÑ Reset Stats</button>
        </div>
        
        <div class="test-log" id="testLog">
            <div class="log-entry log-info">üöÄ Test initialized - Monitoring for infinite loops...</div>
        </div>
    </div>

    <script>
        // Test-specific counters and monitoring
        let clickCount = 0;
        let triggerCount = 0;
        let errorCount = 0;
        let blockCount = 0;
        let lastLogTime = Date.now();
        
        // Create modified app instance for testing
        class TestRateMyLooksApp {
            constructor() {
                this.currentImage = null;
                this.isAnalyzing = false;
                this.fileInputInteractionInProgress = false;
                this.fileInputCooldownMs = 500;
                this.lastFileInputTrigger = 0;
                
                this.setupEventListeners();
                this.setupTestMonitoring();
            }
            
            setupTestMonitoring() {
                // Monitor for potential infinite loops
                this.loopDetector = {
                    eventCounts: {},
                    threshold: 5,
                    timeWindow: 1000,
                    
                    checkForLoop(eventType) {
                        const now = Date.now();
                        if (!this.eventCounts[eventType]) {
                            this.eventCounts[eventType] = [];
                        }
                        
                        // Add current event
                        this.eventCounts[eventType].push(now);
                        
                        // Remove events outside time window
                        this.eventCounts[eventType] = this.eventCounts[eventType].filter(
                            time => (now - time) < this.timeWindow
                        );
                        
                        // Check if threshold exceeded
                        if (this.eventCounts[eventType].length > this.threshold) {
                            this.handlePotentialLoop(eventType);
                            return true;
                        }
                        
                        return false;
                    },
                    
                    handlePotentialLoop(eventType) {
                        errorCount++;
                        updateStats();
                        log(`‚ùå POTENTIAL INFINITE LOOP DETECTED: ${eventType}`, 'error');
                        log(`‚ö†Ô∏è ${this.eventCounts[eventType].length} events in ${this.timeWindow}ms`, 'warning');
                    }
                };
            }
            
            triggerFileInput(fileInput) {
                // Test monitoring
                if (this.loopDetector.checkForLoop('triggerFileInput')) {
                    return false;
                }
                
                const now = Date.now();
                if (this.fileInputInteractionInProgress || (now - this.lastFileInputTrigger) < this.fileInputCooldownMs) {
                    blockCount++;
                    updateStats();
                    log(`üõë File input trigger blocked - cooldown active`, 'warning');
                    return false;
                }

                this.fileInputInteractionInProgress = true;
                this.lastFileInputTrigger = now;
                triggerCount++;
                updateStats();

                log(`üöÄ Triggering file input with safety guards (#${triggerCount})`, 'success');
                
                try {
                    // Simulate file input click without actually triggering it
                    // (to avoid browser file dialog in test)
                    log('‚úÖ File input clicked successfully (simulated)', 'success');
                    return true;
                } catch (error) {
                    errorCount++;
                    updateStats();
                    log(`‚ùå File input click failed: ${error.message}`, 'error');
                    return false;
                } finally {
                    setTimeout(() => {
                        this.fileInputInteractionInProgress = false;
                    }, this.fileInputCooldownMs);
                }
            }
            
            setupEventListeners() {
                const uploadArea = document.getElementById('uploadArea');
                const fileInput = document.getElementById('fileInput');
                const removeBtn = document.getElementById('removeImage');
                
                if (uploadArea && fileInput) {
                    const handleUploadAreaClick = (e) => {
                        // Test monitoring
                        if (this.loopDetector.checkForLoop('uploadAreaClick')) {
                            return;
                        }
                        
                        clickCount++;
                        updateStats();
                        log(`üñ±Ô∏è Upload area clicked (#${clickCount})`, 'info');
                        
                        e.preventDefault();
                        e.stopPropagation();
                        e.stopImmediatePropagation();
                        
                        if (this.currentImage) {
                            log('üì∏ File already selected, ignoring click', 'info');
                            return;
                        }
                        
                        if (this.isAnalyzing) {
                            log('‚è≥ Analysis in progress, ignoring click', 'info');
                            return;
                        }
                        
                        this.triggerFileInput(fileInput);
                    };

                    uploadArea.addEventListener('click', handleUploadAreaClick, { 
                        once: false, 
                        passive: false,
                        capture: false
                    });
                    
                    log('‚úÖ Event listeners attached successfully', 'success');
                }
                
                // File input change handler for testing
                if (fileInput) {
                    fileInput.addEventListener('change', (e) => {
                        if (e.target.files.length > 0) {
                            const file = e.target.files[0];
                            log(`üìÅ File selected: ${file.name}`, 'success');
                            this.processSelectedFile(file);
                        }
                    });
                }
                
                // Remove button handler
                if (removeBtn) {
                    removeBtn.addEventListener('click', () => {
                        this.removeImage();
                    });
                }
            }
            
            processSelectedFile(file) {
                this.currentImage = file;
                const uploadArea = document.getElementById('uploadArea');
                const uploadPreview = document.getElementById('uploadPreview');
                const previewImage = document.getElementById('previewImage');
                const uploadBtn = document.getElementById('uploadBtn');
                
                // Show preview
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewImage.src = e.target.result;
                    uploadArea.style.display = 'none';
                    uploadPreview.style.display = 'block';
                    
                    uploadBtn.disabled = false;
                    uploadBtn.classList.add('enabled');
                };
                reader.readAsDataURL(file);
                
                log(`‚úÖ File processed successfully: ${file.name}`, 'success');
            }
            
            removeImage() {
                this.currentImage = null;
                const uploadArea = document.getElementById('uploadArea');
                const uploadPreview = document.getElementById('uploadPreview');
                const uploadBtn = document.getElementById('uploadBtn');
                const fileInput = document.getElementById('fileInput');
                
                uploadArea.style.display = 'block';
                uploadPreview.style.display = 'none';
                uploadBtn.disabled = true;
                uploadBtn.classList.remove('enabled');
                fileInput.value = '';
                
                log('üóëÔ∏è Image removed', 'info');
            }
        }
        
        // Helper functions for testing
        function log(message, type = 'info') {
            const now = new Date();
            const timestamp = now.toLocaleTimeString() + '.' + now.getMilliseconds().toString().padStart(3, '0');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            
            const testLog = document.getElementById('testLog');
            testLog.insertBefore(logEntry, testLog.firstChild);
            
            // Keep only last 50 entries
            while (testLog.children.length > 50) {
                testLog.removeChild(testLog.lastChild);
            }
        }
        
        function updateStats() {
            document.getElementById('clickCount').textContent = clickCount;
            document.getElementById('triggerCount').textContent = triggerCount;
            document.getElementById('errorCount').textContent = errorCount;
            document.getElementById('blockCount').textContent = blockCount;
        }
        
        function runStressTest() {
            log('üß™ Starting stress test - 100 rapid clicks', 'info');
            const uploadArea = document.getElementById('uploadArea');
            
            for (let i = 0; i < 100; i++) {
                setTimeout(() => {
                    const event = new MouseEvent('click', {
                        view: window,
                        bubbles: true,
                        cancelable: true
                    });
                    uploadArea.dispatchEvent(event);
                    
                    if (i === 99) {
                        log('‚úÖ Stress test completed', 'success');
                    }
                }, i * 10); // 10ms intervals
            }
        }
        
        function simulateEdgeCase() {
            log('‚ö†Ô∏è Testing edge cases', 'warning');
            
            // Test 1: Rapid fire clicks
            const uploadArea = document.getElementById('uploadArea');
            for (let i = 0; i < 10; i++) {
                setTimeout(() => {
                    uploadArea.click();
                }, i);
            }
            
            // Test 2: Overlapping events
            setTimeout(() => {
                const event1 = new MouseEvent('click', { bubbles: true });
                const event2 = new MouseEvent('click', { bubbles: true });
                uploadArea.dispatchEvent(event1);
                uploadArea.dispatchEvent(event2);
            }, 100);
            
            log('‚úÖ Edge case tests completed', 'success');
        }
        
        function clearLogs() {
            const testLog = document.getElementById('testLog');
            testLog.innerHTML = '<div class="log-entry log-info">üöÄ Test logs cleared</div>';
        }
        
        function resetStats() {
            clickCount = 0;
            triggerCount = 0;
            errorCount = 0;
            blockCount = 0;
            updateStats();
            log('üîÑ Statistics reset', 'info');
        }
        
        // Initialize test app
        const testApp = new TestRateMyLooksApp();
        log('‚úÖ Test application initialized', 'success');
        
        // Monitor performance
        setInterval(() => {
            const memoryInfo = performance.memory ? {
                used: Math.round(performance.memory.usedJSHeapSize / 1024 / 1024),
                total: Math.round(performance.memory.totalJSHeapSize / 1024 / 1024)
            } : null;
            
            if (memoryInfo && memoryInfo.used > 100) { // Alert if using more than 100MB
                log(`‚ö†Ô∏è High memory usage: ${memoryInfo.used}MB / ${memoryInfo.total}MB`, 'warning');
            }
        }, 5000);
        
    </script>
</body>
</html>